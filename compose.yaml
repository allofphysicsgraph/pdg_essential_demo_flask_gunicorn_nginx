# Ben Payne
# Physics Derivation Graph
# https://allofphysics.com

# Creative Commons Attribution 4.0 International License
# https://creativecommons.org/licenses/by/4.0/

# https://docs.docker.com/compose/compose-file/

services:
  flask-webserver:
    build:
      context: ./webserver_for_pdg
      dockerfile: Dockerfile
    restart: unless-stopped
    # https://stackoverflow.com/questions/29377853/how-can-i-use-environment-variables-in-docker-compose
    # https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/
    expose:
      - 5000
    # using "ports" makes flask/gunicorn accessible without going through nginx
    # ports:
    #  - "5000:5000"
    # https://docs.gunicorn.org/en/stable/settings.html
    # https://pythonspeed.com/articles/gunicorn-in-docker/
    command: >
      gunicorn
      --reload
      --bind 0.0.0.0:5000
      --forwarded-allow-ips="*"
      --log-level debug
      wsgi:pdg_app
      --capture-output
      --log-file=gunicorn_logs.log
      --access-logformat='{"ip":"%({X-Forwarded-For}i)s", "reqtime":"%(L)s", "uname":"%(u)s", "date":"%(t)s", "statline":"%(r)s", "stat":  "%(s)s", "resplen":"%(b)s", "ref":"%(f)s", "ua":"%(a)s"}'
      --access-logfile=gunicorn_access.log
      --error-logfile=gunicorn_error.log
      --worker-tmp-dir /dev/shm
      --workers=2 
      --threads=4 
      --worker-class=gthread 
#      --enable-stdio-inheritance
    networks:
      this-internal:
    volumes:
      - ${PWD}/:/scratch

  nginx:
    build: ./nginx_for_pdg
    # https://docs.docker.com/reference/compose-file/services/#depends_on
    depends_on: 
      flask-webserver:
        condition: service_started
    restart: on-failure
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${PWD}/logs_nginx/:/logs/
    networks:
      this-internal:

networks:
  this-internal:
    driver: bridge

# EOF
